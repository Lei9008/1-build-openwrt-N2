#============================================================================================
# https://github.com/ophub/amlogic-s9xxx-openwrt
# Description: Build OpenWrt
#============================================================================================

name: Openwrt_NeWiFi_D2_ç¼–è¯‘å›ºä»¶

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      source_branch:
        description: "é€‰æ‹©æºåˆ†æ”¯(Select the source branch)"
        required: false
        default: "openwrt-main"
        type: choice
        options:
          - openwrt-main
          - lede-master
          - immortalwrt-master
          - Lienol-master
     
env:
  FEEDS_CONF: config/${{ inputs.source_branch }}/feeds.conf.default
  CONFIG_FILE: config/${{ inputs.source_branch }}/Newifi_D2.config
  DIY_P1_SH: config/${{ inputs.source_branch }}/diy-part1.sh
  DIY_P2_SH: config/${{ inputs.source_branch }}/diy-part2.sh
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

# åˆ é™¤æ— ç”¨æ–‡ä»¶ä»¥å¢åŠ ç¼–è¯‘ç©ºé—´
  DELETE_USELESS_FILES: true
# åˆ é™¤æ—©æœŸçš„ workflow ä»»åŠ¡
  DELETE_OLD_WORKFLOW: true
# Cache åŠ é€Ÿç¼–è¯‘
  CACHE_ACCELERATE: true
### ç»“æŸ
### è¯·æŒ‰éœ€æ±‚ä¿®æ”¹ä»¥ä¸Šå†…å®¹

jobs:
  build:
    runs-on: ubuntu-22.04
    if: ${{ github.event.repository.owner.id }} == ${{ github.event.sender.id }}

   
    steps:

      - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´ (Optimize disk space)
        if: env.DELETE_USELESS_FILES == 'true' && !cancelled()
        uses: "hugoalh/disk-space-optimizer-ghaction@v0.8.0"
        with:
          operate_sudo: "True"
          general_include: ".+"
          general_exclude: |-
            ^GCC$
            ^G\+\+$
            Clang
            LLVM
          docker_include: ".+"
          docker_prune: "True"
          docker_clean: "True"
          apt_prune: "True"
          apt_clean: "True"
          homebrew_prune: "True"
          homebrew_clean: "True"
          npm_prune: "True"
          npm_clean: "True"
          os_swap: "True"

      - name: é‡Šæ”¾ç£ç›˜ç©ºé—´ (Free up disk space)
        if: env.DELETE_USELESS_FILES == 'true' && !cancelled()
        uses: easimon/maximize-build-space@master
        with: 
          root-reserve-mb: 2048
          swap-size-mb: 1
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: æ£€å‡º(Checkout)
        uses: actions/checkout@main

      - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
        run: |
         echo "è­¦å‘Šâš "
         echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
         echo "äº‘ç¼–è¯‘å»ºè®®å–æ¶ˆå‹¾é€‰Node.jsåŠå…¶ç›¸å…³æ’ä»¶ï¼"
         echo "å·²çŸ¥CPUå‹å·ï¼ˆé™åºï¼‰ï¼š8370C,8272CL,8171M,E5ç³»åˆ—"
         echo "--------------------------CPUä¿¡æ¯--------------------------"
         echo "CPUç‰©ç†æ•°é‡:$(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
         echo -e "CPUæ ¸å¿ƒåŠç‰ˆæœ¬ä¿¡æ¯ï¼š$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
         echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
         echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯ï¼š"
         sudo lshw -short -C memory | grep GiB
         echo -e "\n"
         echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
         echo -e  "ç¡¬ç›˜æ•°é‡ï¼š$(ls /dev/sd* | grep -v [1-9] | wc -l) \n"
         echo "ç¡¬ç›˜è¯¦æƒ…ï¼š"
         df -Th

      - name: åˆå§‹åŒ–ç¯å¢ƒ(Initialization environment)
        id: init
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi `docker images -q`
          [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && sudo rm -rf "${AGENT_TOOLSDIRECTORY}"
          sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android 2>/dev/null
          sudo -E apt-get -y update
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
          sudo -E apt-get -y install $(curl -fsSL https://is.gd/depend_ubuntu2204_openwrt)
          sudo -E systemctl daemon-reload
          #sudo -E apt-get -y full-upgrade
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean
          sudo mkdir -p /workdir
          sudo chown ${USER}:${GROUPS} /workdir
          sudo timedatectl set-timezone "${TZ}"
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: å…‹éš†æºä»£ç (Clone source code) [ ${{ inputs.source_branch }} ]
        id: codes
        working-directory: /workdir
        if: ${{ steps.init.outputs.status }} == 'success' && !cancelled()
        run: |
          # Set up compilation source code
          if [[ "${{ inputs.source_branch }}" == *"openwrt"* ]]; then
              REPO_URL="https://github.com/openwrt/openwrt"
              REPO_BRANCH="main"
              TAGS_NAME="official"
          elif [[ "${{ inputs.source_branch }}" == *"lede"* ]]; then
              REPO_URL="https://github.com/coolsnowwolf/lede"
              REPO_BRANCH="master"
              TAGS_NAME="lede"
          elif [[ "${{ inputs.source_branch }}" == *"immortalwrt"* ]]; then
              REPO_URL="https://github.com/immortalwrt/immortalwrt"
              REPO_BRANCH="master"
              TAGS_NAME="immortalwrt"
          elif [[ "${{ inputs.source_branch }}" == *"Lienol"* ]]; then
              REPO_URL="https://github.com/Lienol/openwrt"
              REPO_BRANCH="22.03"
              TAGS_NAME="Lienol"
          else
              echo "Unknown source code repository."
              exit 1
          fi

          # Clone source code
          git clone -q --single-branch --depth=1 --branch=${REPO_BRANCH} ${REPO_URL} openwrt
          ln -sf /workdir/openwrt ${GITHUB_WORKSPACE}/openwrt

          # Set output information
          echo "build_tag=OpenWrt_${TAGS_NAME}_${{ inputs.openwrt_storage }}_$(date +"%Y.%m")" >> ${GITHUB_OUTPUT}
          echo -e "REPO_URL: [ ${REPO_URL} ]\nREPO_BRANCH: [ ${REPO_BRANCH} ]\nTAGS_NAME: [ ${TAGS_NAME} ]"
          df -hT ${PWD}
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: æé€Ÿ (Accelerate)
        if: env.CACHE_ACCELERATE == 'true'
        uses: klever1988/cachewrtbuild@main
        with:
          ccache: false
          toolchain: true
          skip: true
          clean: true
          prefix: ${{ github.workspace }}/openwrt

      - name: åŠ è½½è‡ªå®šä¹‰æº(Load custom feeds)
        run: |
          [[ -f "${FEEDS_CONF}" ]] && cp -f ${FEEDS_CONF} openwrt/feeds.conf.default
          chmod +x ${DIY_P1_SH}
          cd openwrt/
          ${GITHUB_WORKSPACE}/${DIY_P1_SH}

      - name: æ›´æ–°æº(Update feeds)
        run: cd openwrt/ && ./scripts/feeds update -a

      - name: å®‰è£…æº (Install feeds)
        run: cd openwrt/ && ./scripts/feeds install -a

      - name: åŠ è½½è‡ªå®šä¹‰é…ç½®(Load custom configuration)
        run: |
          [[ -d "files" ]] && mv -f files openwrt/files
          [[ -e "${CONFIG_FILE}" ]] && cp -f ${CONFIG_FILE} openwrt/.config
          chmod +x ${DIY_P2_SH}
          cd openwrt/
          ${GITHUB_WORKSPACE}/${DIY_P2_SH}

      - name: ä¸‹è½½è½¯ä»¶åŒ…(Download package)
        id: package
        run: |
          cd openwrt/
          make defconfig
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: ç¼–è¯‘OpenWrt(Compile the OpenWrt)
        id: compile
        run: |
          cd openwrt/
          echo -e "$(nproc) thread compile"
          make -j$(($(nproc) + 1)) V=s || make -j1 || make -j1 V=s
          echo "status=success" >> ${GITHUB_OUTPUT}


      - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ(Check space usage)
        if: (!cancelled())
        run: df -hT

      - name: ä¸Šä¼ binç›®å½•(Upload bin directory)
        uses: actions/upload-artifact@main
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        with:
          name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/bin

      - name: æ•´ç†æ–‡ä»¶(Organize files)
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "::set-output name=status::success"

      - name: ä¸Šä¼ å›ºä»¶ç›®å½•(Upload firmware directory)
        uses: actions/upload-artifact@main
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾(Generate release tag)
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          echo "::set-output name=release_tag::$(date +"%Y.%m.%d-%H%M")"
          touch release.txt
          [ $UPLOAD_COWTRANSFER = true ] && echo "ğŸ”— [Cowtransfer](${{ steps.cowtransfer.outputs.url }})" >> release.txt
          [ $UPLOAD_WETRANSFER = true ] && echo "ğŸ”— [WeTransfer](${{ steps.wetransfer.outputs.url }})" >> release.txt
          echo "::set-output name=status::success"

      - name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬(Upload firmware to release)
        uses: softprops/action-gh-release@v1
        if: steps.tag.outputs.status == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*

      - name: åˆ é™¤å·¥ä½œæµè¿è¡Œ(Delete workflow runs)
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 3
          token: ${{ secrets.GH_TOKEN }}
          body: |

            ### OpenWrt Image information
            - Default IP: 192.168.5.1
            - Default username: root
            - Default password: password
            - Default WIFI name: HiWiFi
            - Default WIFI password: he1235678
            ### Install to EMMC
            - Login to OpenWrt â†’ System â†’ Amlogic Service â†’ Install OpenWrt
            ### OpenWrt Image Verification
            - sha256sum
    
